<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Annuaire des &eacute;tablissements</title>

    <meta name="description" content="Source code generated by Michel Mvouma">
    <meta name="author" content="LayoutIt!">

    <link href="/stylesheets/bootstrap.min.css" rel="stylesheet">
    <link href="/stylesheets/style.css" rel="stylesheet">
    <link href="/stylesheets/select2.min.css" rel="stylesheet">
    <link href="/stylesheets/magicsuggest-min.css" rel="stylesheet">
    <link href="/stylesheets/bootstrap-table.min.css" rel="stylesheet">


</head>
<body>

<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="row">
                <div class="col-md-2">
                </div>
                <div class="col-md-3">
                </div>
                <div class="col-md-3">
                </div>
                <div class="col-md-4">
                </div>
            </div>
            <div class="row">
                <div class="col-md-12">
                    <div class="tabbable" id="tabs-297431">
                        <ul class="nav nav-tabs">
                            <li class="active">
                                <a href="#panel-recherche" data-toggle="tab">Recherche</a>
                            </li>
                            <li>
                                <a href="#panel-373365" data-toggle="tab">Statistiques</a>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane active" id="panel-recherche"><!--div contenant tous les elements-->
                                <div class="row well">
                                    <div class="col-lg-12">

                                      <table class="table" id="myTable1">
                                          <tr>
                                              <td width="5%">
                                                  <label for="nomE" class="control-label">Nom:</label>
                                              </td>
                                              <td>

                                                 <input type="text" class="form-control" name="etablissements[]" id="nomE">
                                              </td>
                                          </tr>
                                      </table>
                                       <div class="row">
                                           <div class="col-lg-4 form-horizontal">
                                               <div class="form-group">
                                                   <label for="uai" class="col-sm-2 control-label">UAI:</label>
                                                   <div class="col-sm-8">
                                                       <input type="text" class="form-control" id="uai">
                                                   </div>
                                               </div>


                                               <div class="form-group">
                                                   <label for="region" class="col-sm-2 control-label">R&eacute;gion:</label>
                                                   <div class="col-sm-10">
                                                       <select id="region"  tabindex="-1" aria-hidden="true" style="width: 78%" multiple="">
                                                       </select>
                                                       <!--<input type="text" class="form-control"  placeholder="Saisir une r&eacute;gion">-->
                                                   </div>
                                               </div>

                                           </div>

                                           <div class="col-lg-4 form-horizontal">

                                               <div class="form-group">
                                                   <label for="academie" class="col-sm-2 control-label">Academie:</label>
                                                   <div class="col-sm-10">
                                                       <select id="academie"  tabindex="-1" aria-hidden="true" style="width: 78%" multiple="">
                                                       </select>
                                                   </div>
                                               </div>

                                               <div class="form-group">
                                                   <label for="tutelle" class="col-sm-2 control-label">Tutelle:</label>
                                                   <div class="col-sm-10">
                                                       <select id="tutelle"  tabindex="-1" aria-hidden="true" style="width: 78%" multiple="">

                                                       </select>
                                                   </div>
                                               </div>

                                               <div class="form-group">
                                                   <label for="sigle" class="col-sm-2 control-label">Sigle:</label>
                                                   <div class="col-sm-10">
                                                       <select id="sigle"  tabindex="-1" aria-hidden="true" style="width: 78%" multiple="">
                                                       </select>
                                                   </div>
                                               </div>

                                               <div class="form-group">
                                                   <label class="col-sm-4 control-label"></label>
                                                   <div class="col-sm-8">
                                                       <a class="btn btn btn-success" id="look">Rechercher</a>

                                                   </div>

                                               </div>

                                              <div class="form-group">
                                                  <div class="col-sm-8 col-lg-offset-3">
                                                      <img src="/images/ajax-loader.gif" id="loadingI" style="display:none" />
                                                  </div>
                                              </div>

                                           </div>

                                           <div class="col-lg-4 form-horizontal">
                                               <div class="form-group">
                                                   <label for="univ" class="col-sm-2 control-label">Universit&eacute;:</label>
                                                   <div class="col-sm-10">
                                                       <!--<input type="text" class="form-control" id="univ" placeholder="Saisir une universit&eacute;">-->
                                                       <select id="univ"  tabindex="-1" aria-hidden="true" style="width: 78%" multiple="">

                                                       </select>
                                                   </div>
                                               </div>

                                               <div class="form-group">
                                                   <label for="statut" class="col-sm-2 control-label">Statut:</label>
                                                   <div class="col-sm-10">
                                                       <select id="statut"  tabindex="-1" aria-hidden="true" style="width: 78%" multiple="" >

                                                       </select>
                                                       <!--<input type="text" class="form-control" id="statut" placeholder="Saisir un statut">-->
                                                   </div>
                                               </div>

                                               <div class="form-group">
                                                   <label for="type" class="col-sm-2 control-label">Type:</label>
                                                   <div class="col-sm-10">
                                                       <select id="type"  tabindex="-1" aria-hidden="true" style="width: 78%" multiple="" >

                                                       </select>
                                                       <!--<input type="text" class="form-control" id="statut" placeholder="Saisir un statut">-->
                                                   </div>
                                               </div>

                                               <div class="form-group hidden">
                                                   <label for="myJocker" class="col-sm-2 control-label"></label>
                                                   <div class="col-sm-8">
                                                       <input type="text" class="form-control" id="myJocker" placeholder="do the job">
                                                   </div>
                                               </div>
                                           </div>
                                       </div>
                                    </div>



                                </div><!--fin panneau de recherche-->


                                <div class="row">
                                    <div class="col-lg-12">
                                        <ul class="nav nav-pills">
                                            <li>
                                                <a href="#panel-liste" data-toggle="tab">Etablissement</a>
                                            </li>
                                            <li class="active">
                                                <a href="#panel-carte" data-toggle="tab">Carte</a>
                                            </li>
                                        </ul>

                                        <div class="tab-content">
                                            <div class="tab-pane" id="panel-liste"><!--div contenant tous les elements-->
                                                <div class="row">
                                                    <div class="col-lg-12">
                                                        <table id="tableEtablissements">
                                                            <thead>
                                                                <tr>
                                                                 <th data-field="state" data-checkbox="true"></th>
                                                                <th data-halign="center" data-field="uai" data-width="5%">UAI</th>
                                                                <th data-halign="center" data-align="center"  data-field="name" data-sortable="true">NOM</th>
                                                                <th data-halign="center" data-align="center" data-field="type">TYPE</th>
                                                                <th data-halign="center" data-align="center" data-field="sigle" data-width="5%">SIGLE</th>
                                                                <th data-halign="center" data-align="center" data-field="tutelle">TUTELLE</th>
                                                                <th data-halign="center" data-align="center" data-field="adresse" data-width="20%">ADRESSE</th>
                                                                <th data-halign="center" data-align="center" data-field="longitude" data-width="5%" class="hidden">Long</th>
                                                                <th data-halign="center" data-align="center" data-field="latitude" data-width="5%" class="hidden">Lat</th>
                                                                </tr>
                                                            </thead>

                                                            <tbody id="myTbody">

                                                            </tbody>
                                                        </table>
                                                    </div>
                                                </div>
                                            </div><!--fin du panel-->

                                            <div class="tab-pane active" id="panel-carte">

                                                <div class="row">
                                                    <div class="col-lg-12" style="">
                                                        <div id="map" style="width: 100%; height: 400px;">

                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                </div>
                            </div><!--fin du panel-->

                            <div class="tab-pane" id="panel-373365">
                                <p>statistics</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="/javascripts/jquery.min.js"></script>
<script src="/javascripts/bootstrap.min.js"></script>
<script src="/javascripts/scripts.js"></script>
<script src="/javascripts/select2.full.min.js"></script>
<script src="/javascripts/magicsuggest-min.js"></script>
<script src="/javascripts/bootstrap-table.min.js"></script>
<script src="/javascripts/bootstrap-table-locale-all.min.js"></script>
<script src="https://maps.googleapis.com/maps/api/js"></script>
<script src="/javascripts/main_js.js"></script>

<script>
    $(function()
    {

        $("#myTable1").css({'border-top': '0px solid #ddd'});//pour enlever la ligne en haut du tableau utiliser ceci cette propriété
         /*
             CONSTRUCTION DU TABLEAU AFIN DE RESERVOIR LES DONNEES DE LA RECHERCHE
         */
        var $tableB=$('#tableEtablissements').bootstrapTable({
            pagination:true,
            search:true,
            locale:'fr-FR',
            halign:"center",
            pageSize:8,
            sidePagination:'client',
            pageNumber:1

        });

        var uai="";
        var nomEtablissement="", conditionRegion='', conditionAcademie='', conditionTutelle='', conditionSigle='', conditionUniversite='';
        var conditionStatut='', conditionType='', conditionUAI='', conditionNomEtab='', urlT='';

        var optionRegions = [], optionAcademie =[], optionTutelle =[], optionSigle =[], optionUniversite =[], optionStatut =[];
        var optionType =[], optionUAI =[], dataEtabCarte=[];
        $("#region").select2({
            placeholder: "Saisir une région",
            language: "fr"

        });

        /*
          COMPOSANT POUR LES DONNEES DES ETABLISSEMENTS
        */
        var $ms = $('#nomE').magicSuggest({
            placeholder: "Etablissement",
            maxSelection:10,
            noSuggestionText:'aucun établissement',
            sortOrder: 'name'
        });

        /*
           EVENEMENT SUR LE TAB CARTE ET RECUPERATION DE TOUS LES ETABLISSEMENTS COCHES
        */
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            var target = $(e.target).attr("href"); // activated tab
           if(target=='#panel-carte')
           {
               var dataSelected = $tableB.bootstrapTable('getAllSelections');
               console.log(dataSelected);
           }
        });
        /*
           MAGIC SUGGEST POUR LE UAI ETABLISSEMENT
        */
        var $uaiMs = $('#uai').magicSuggest({
            placeholder: "UAI",
            maxSelection:10,
            noSuggestionText:'aucun uai',
            sortOrder: 'name'
        });


         /*
           trigger sur le nom des etablissements
         */
        $($ms).on('triggerclick', function(c)
        {
            manager(true);
            var suggest = this;

            if($("#myJocker").val()!='import module namespace functx = "http://www.functx.com";  functx:distinct-nodes(db:open("etablissement_superieur")//etablissement)')//
            {
                $.ajax({
                    url: "/controller/expandEtablissement",
                    dataType:'json',
                    data:{

                        jocker:$("#myJocker").val()
                    },
                    success:function(data)
                    {
                        //console.log(data);
                        if(data.length>0)
                        {
                            suggest.setData(data);
                            var dataMin = modifyData(data);
                            $uaiMs.setData(dataMin);
                        }else{
                            suggest.setData([]);
                            $uaiMs.setData([]);
                        }
                    }
                });
            }

        });


        $("#statut").select2({
            placeholder: "Saisir un statut",
            language: "fr"

        });

        $("#univ").select2({
            placeholder: "Choisir une université",
            language: "fr"

        });

        $("#tutelle").select2({
            placeholder: "Choisir une tutelle",
            language: "fr"

        });

        $("#type").select2({
            placeholder: "Choisir un type",
            language: "fr"

        });

        $("#academie").select2({
            placeholder: "Choisir une académie",
            language: "fr"

        });

        $("#sigle").select2({
            placeholder: "Choisir un sigle",
            language: "fr"

        });

        $.getJSON( "/controller/region", function(data ) {
            var items = [];
           $('#region option').remove();
            $.each( data, function( key, val ) {
                $('#region').append('<option value="'+val.name+'">'+val.name+'</option>');
            });
            $('#region').select2().trigger('change');
        });

        $.getJSON( "/controller/academie", function(data ) {
            var items = [];
            $('#academie option').remove();
            $.each( data, function( key, val ) {
                $('#academie').append('<option value="'+val.name+'">'+val.name+'</option>');
            });
            $('#academie').select2().trigger('change');
        });

        $.getJSON( "/controller/tutelle", function(data ) {
            var items = [];
            $('#tutelle option').remove();
            $.each( data, function( key, val ) {
                $('#tutelle').append('<option value="'+val.name+'">'+val.name+'</option>');
            });
            $('#tutelle').select2().trigger('change');
        });

        $.getJSON( "/controller/sigle", function(data ) {
            var items = [];
            $('#sigle option').remove();
            $.each( data, function( key, val ) {
                $('#sigle').append('<option value="'+val.name+'">'+val.name+'</option>');
            });
            $('#sigle').select2().trigger('change');
        });

        $.getJSON( "/controller/universite", function(data ) {
            var items = [];
            $('#univ option').remove();
            $.each( data, function( key, val ) {
                $('#univ').append('<option value="'+val.name+'">'+val.name+'</option>');
            });
            $('#univ').select2().trigger('change');
        });

        $.getJSON( "/controller/statut", function(data ) {
            var items = [];
            $('#statut option').remove();
            $.each( data, function( key, val ) {
                $('#statut').append('<option value="'+val.name+'">'+val.name+'</option>');
            });
            $('#statut').select2().trigger('change');
        });

        $.getJSON( "/controller/type", function(data ) {
            var items = [];
            //$('#type option').remove();
            $.each( data, function( key, val ) {
                $('#type').append('<option value="'+val.name+'">'+val.name+'</option>');
            });
            $('#type').select2().trigger('change');
        });

        /*JUST FOR EVENT BECAUSE I WOULID LIKE TO FORM MY REQUEST IN BASEX WITH OPTION SELECT BY USER*/
        $("#region").on("change", function ()
        {
        });

        /*
             CLICK SUR LE BOUTON RECHERCHE EVENT
         */
        $('#look').click(function(){
            manager(false);
            //console.log("recherche");
            $('#loadingI').show();
            $.ajax({
                url: "/controller/expandEtablissement",
                dataType:'json',
                data:{

                    jocker:$("#myJocker").val()
                },
                success:function(data)
                {
                    //console.log("reponse look"+ data);
                    managerEtablissement(data);
                   $('#loadingI').hide();
                }
            });
        });

         /*
            fonction permettant de faire les recherches
          */
        function manager(whichJob)
        {
            optionRegions = $("#region").val();
            optionAcademie = $("#academie").val();
            optionTutelle= $("#tutelle").val();
            optionSigle= $("#sigle").val();

            optionUniversite= $("#univ").val();
            optionStatut= $("#statut").val();
            optionType= $("#type").val();
            var tabSelectionUai = $uaiMs.getSelection();

            var tabCondition=[];
            urlT="";


            conditionUAI="";
            conditionNomEtab="";
            if(tabSelectionUai.length>0)// uai.length
            {
                conditionUAI='UAI=(';
                for(var i =0; i<tabSelectionUai.length; i++)
                {
                    if(i+1!=tabSelectionUai.length)
                    {
                        conditionUAI+='"'+(tabSelectionUai[i].name).toUpperCase()+'",';
                    }else{
                        conditionUAI+='"'+(tabSelectionUai[i].name).toUpperCase()+'"';
                    }
                }
                conditionUAI+=')';
                tabCondition.push(conditionUAI);
            }


            //console.log(typeof $("#uai").val() + " valeur");
            conditionRegion="";
            if(optionRegions!==null)
            {
                conditionRegion="region=(";
                for(var i =0; i<optionRegions.length; i++)
                {
                    if(i+1!=optionRegions.length)
                    {
                        conditionRegion+='"'+optionRegions[i]+'",'
                    }else{
                        conditionRegion+='"'+optionRegions[i]+'"'
                    }
                }
                conditionRegion+=')';
                // console.log(conditionRegion);
                tabCondition.push(conditionRegion);
            }

            conditionAcademie="";
            if(optionAcademie!==null)
            {
                conditionAcademie="academie=(";
                for(var i =0; i<optionAcademie.length; i++)
                {
                    if(i+1!=optionAcademie.length)
                    {
                        conditionAcademie+='"'+optionAcademie[i]+'",'
                    }else{
                        conditionAcademie+='"'+optionAcademie[i]+'"'
                    }
                }
                conditionAcademie+=')';
                //console.log(conditionAcademie);
                tabCondition.push(conditionAcademie);
            }


            conditionTutelle="";
            if(optionTutelle!==null)
            {
                conditionTutelle="tutelle=(";
                for(var i =0; i<optionTutelle.length; i++)
                {
                    if(i+1!=optionTutelle.length)
                    {
                        conditionTutelle+='"'+optionTutelle[i]+'",'
                    }else{
                        conditionTutelle+='"'+optionTutelle[i]+'"'
                    }
                }
                conditionTutelle+=')';
                tabCondition.push(conditionTutelle);
                // console.log(conditionTutelle);
            }

            conditionSigle="";
            if(optionSigle!==null)
            {
                conditionSigle="sigle=(";
                for(var i =0; i<optionSigle.length; i++)
                {
                    if(i+1!=optionSigle.length)
                    {
                        conditionSigle+='"'+optionSigle[i]+'",'
                    }else{
                        conditionSigle+='"'+optionSigle[i]+'"'
                    }
                }
                conditionSigle+=')';
                //console.log(conditionSigle);
                tabCondition.push(conditionSigle);
            }


            conditionUniversite="";
            if(optionUniversite!==null)
            {
                conditionUniversite="universite=(";
                for(var i =0; i<optionUniversite.length; i++)
                {
                    if(i+1!=optionUniversite.length)
                    {
                        conditionUniversite+='"'+optionUniversite[i]+'",'
                    }else{
                        conditionUniversite+='"'+optionUniversite[i]+'"'
                    }
                }
                conditionUniversite+=')';
                //console.log(conditionUniversite);
                tabCondition.push(conditionUniversite);
            }

            conditionStatut="";
            if(optionStatut!==null)
            {
                conditionStatut="statut=(";
                for(var i =0; i<optionStatut.length; i++)
                {
                    if(i+1!=optionStatut.length)
                    {
                        conditionStatut+='"'+optionStatut[i]+'",'
                    }else{
                        conditionStatut+='"'+optionStatut[i]+'"'
                    }
                }
                conditionStatut+=')';
                //console.log(conditionStatut);
                tabCondition.push(conditionStatut);
            }


            conditionType="";
            if(optionType!==null)
            {
                conditionType="type=(";
                for(var i =0; i<optionType.length; i++)
                {
                    if(i+1!=optionType.length)
                    {
                        conditionType+='"'+optionType[i]+'",'
                    }else{
                        conditionType+='"'+optionType[i]+'"'
                    }
                }
                conditionType+=')';
                tabCondition.push(conditionType);
                //console.log(conditionType);
            }

            if(whichJob)
            {
                if(tabCondition.length>0)
                {
                    urlT+='import module namespace functx = "http://www.functx.com";  functx:distinct-nodes(db:open("etablissement_superieur")//etablissement[';
                    for(var i =0; i<tabCondition.length; i++)
                    {
                        if(i+1!=tabCondition.length)
                        {
                            urlT+=tabCondition[i]+" and ";
                        }else{
                            urlT+=tabCondition[i];
                        }
                    }
                    urlT+="])"
                }else{
                    urlT+='import module namespace functx = "http://www.functx.com";  functx:distinct-nodes(db:open("etablissement_superieur")//etablissement)';
                }
            }else if(!whichJob)
            {
                var tabSelectionEtablissements = $ms.getSelection();
                if(tabSelectionEtablissements.length>0)
                {
                    conditionNomEtab='nom=(';
                    for(var i =0; i<tabSelectionEtablissements.length; i++)
                    {
                        if(i+1!=tabSelectionEtablissements.length)
                        {
                            conditionNomEtab+='"'+tabSelectionEtablissements[i].name+'",';
                        }else{
                            conditionNomEtab+='"'+tabSelectionEtablissements[i].name+'"';
                        }
                    }
                    conditionNomEtab+=')';
                    tabCondition.push(conditionNomEtab);
                }

                if(tabCondition.length>0)
                {
                    urlT+='import module namespace functx = "http://www.functx.com";  functx:distinct-nodes(db:open("etablissement_superieur")//etablissement[';
                    for(var i =0; i<tabCondition.length; i++)
                    {
                        if(i+1!=tabCondition.length)
                        {
                            urlT+=tabCondition[i]+" and ";
                        }else{
                            urlT+=tabCondition[i];
                        }
                    }
                    urlT+="])"
                }else{
                    urlT+='import module namespace functx = "http://www.functx.com";  functx:distinct-nodes(db:open("etablissement_superieur")//etablissement)';
                }

            }


            $("#myJocker").val(urlT);
           // console.log('url ' + $("#myJocker").val());
        }

        function managerEtablissement(dataEtab)
        {
            $tableB.bootstrapTable('removeAll');
            dataEtabCarte=[];
            dataEtabCarte=dataEtab;
            for(var i =0; i<dataEtab.length; i++)
            {
                $tableB.bootstrapTable('insertRow',
                        {
                            index: i+1,
                            row:
                            {
                                state:false,
                                uai:dataEtab[i].id,
                                name:dataEtab[i].name,
                                type:dataEtab[i].typeEtab,
                                sigle:dataEtab[i].sigle,
                                tutelle:dataEtab[i].tutelle,
                                adresse:dataEtab[i].adresseEtab,
                                longitude:parseFloat(dataEtab[i].longitude),
                                latitude:parseFloat(dataEtab[i].latitude)
                            }
                        }
                );

            }
            $tableB.bootstrapTable('refresh');
        }


    });
    function initialize()
    {
        var mapContainer = document.getElementById('map');
        var mapOptions = {
            center: new google.maps.LatLng(44.5403, -78.5463),
            zoom: 8,
            mapTypeId: google.maps.MapTypeId.ROADMAP
        }
        var map = new google.maps.Map(mapContainer, mapOptions);
    }
    google.maps.event.addDomListener(window, 'load', initialize);
</script>
</body>
</html>